<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Inside</title>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  image-rendering: pixelated;
}

html, body {
  width: 100%;
  height: 100%;
  background: black;
  overflow: hidden;
  font-family: monospace;
}

/* ---------- SCENE LAYERS ---------- */
#scene, #scene2 {
  position: absolute;
  inset: 0;
  background-position: center;
  background-size: cover;
  background-repeat: no-repeat;
}

#scene2 {
  opacity: 0;
  transition: opacity 3s ease;
}

/* ---------- FADE ---------- */
#fade {
  position: absolute;
  inset: 0;
  background: black;
  opacity: 1;
  transition: opacity 3s ease;
  z-index: 10;
  pointer-events: none;
}

/* ---------- DIALOGUE ---------- */
#dialogue {
  position: absolute;
  bottom: 16%;
  width: 100%;
  text-align: center;
  color: white;
  font-size: 3vw;
  letter-spacing: 3px;
  opacity: 0;
  transition: opacity 2s ease;
}

/* ---------- PROMPT ---------- */
#prompt {
  display: none;
  position: absolute;
  bottom: 8%;
  width: 100%;
  text-align: center;
  font-size: 2.6vw;
  color: #ffd84d;
  animation: blink 2.5s infinite;
}

@keyframes blink {
  0%,100% { opacity: 0.3; }
  50% { opacity: 1; }
}

/* ---------- PORTRAIT ---------- */
@media (orientation: portrait) {
  body { filter: blur(6px); }
}
</style>
</head>

<body>

<div id="scene"></div>
<div id="scene2"></div>
<div id="fade"></div>
<div id="dialogue"></div>
<div id="prompt"></div>

<audio id="bgm" src="bg.mp3" loop></audio>
<audio id="tapSound" src="tap.mp3"></audio>

<script>
const scene = document.getElementById("scene");
const scene2 = document.getElementById("scene2");
const fade = document.getElementById("fade");
const dialogue = document.getElementById("dialogue");
const prompt = document.getElementById("prompt");

const bgm = document.getElementById("bgm");
const tapSound = document.getElementById("tapSound");

let bgmStarted = false;
let canTap = false;
let stage = 0;

/* ---------- INITIAL ---------- */
scene.style.backgroundImage = 'url("1.png")';

window.addEventListener("load", () => {
  setTimeout(() => fade.style.opacity = "0", 800);
  setTimeout(startDialogue, 5000);
});

/* ---------- TYPEWRITER ---------- */
function typeText(text, done) {
  dialogue.textContent = "";
  dialogue.style.opacity = "1";
  let i = 0;

  const t = setInterval(() => {
    dialogue.textContent += text[i++];
    if (i >= text.length) {
      clearInterval(t);
      setTimeout(done, 4000);
    }
  }, 140);
}

/* ---------- DIALOGUE FLOW ---------- */
function startDialogue() {
  typeText("You're tired and heavy", () => {
    dialogue.style.opacity = "0";

    setTimeout(() => {
      typeText("You should keep your belongings aside", () => {
        dialogue.style.opacity = "0";

        setTimeout(() => {
          showPrompt("Tap to place your umbrella");
          stage = 1;
          canTap = true;
        }, 3000);
      });
    }, 3000);
  });
}

/* ---------- PROMPT ---------- */
function showPrompt(text) {
  prompt.textContent = text;
  prompt.style.display = "block";
}

/* ---------- AUDIO ---------- */
document.addEventListener("pointerdown", () => {
  if (!bgmStarted) {
    bgm.volume = 0.6;
    bgm.play().catch(()=>{});
    bgmStarted = true;
  }
  tapSound.currentTime = 0;
  tapSound.play().catch(()=>{});
});

/* ---------- DIFFUSION ---------- */
function diffuseTo(img, callback) {
  scene2.style.backgroundImage = `url("${img}")`;
  scene2.style.opacity = "1";

  setTimeout(() => {
    scene.style.backgroundImage = `url("${img}")`;
    scene2.style.opacity = "0";
    if (callback) callback();
  }, 3000);
}

/* ---------- SHORT CIRCUIT ---------- */
function shortCircuit(callback) {
  let count = 0;
  const flicker = setInterval(() => {
    scene.style.backgroundImage =
      count % 2 === 0 ? 'url("3.png")' : 'url("4.png")';
    count++;
    if (count >= 20) {
      clearInterval(flicker);
      scene.style.backgroundImage = 'url("4.png")';
      callback();
    }
  }, 120);
}

/* ---------- TAP LOGIC ---------- */
document.addEventListener("click", () => {
  if (!canTap) return;
  canTap = false;
  prompt.style.display = "none";

  /* Place umbrella */
  if (stage === 1) {
    diffuseTo("2.png", () => {
      showPrompt("Tap to put rest of your belongings");
      stage = 2;
      canTap = true;
    });
  }

  /* Place rest + power cut */
  else if (stage === 2) {
    diffuseTo("3.png", () => {
      setTimeout(() => {
        shortCircuit(() => {
          setTimeout(() => {
            typeText("Power cut", () => {
              dialogue.style.opacity = "0";
              setTimeout(() => {
                typeText("Flashlight must be upstairs", () => {
                  dialogue.style.opacity = "0";
                  setTimeout(() => {
                    showPrompt("Tap to follow stairs");
                    stage = 3;
                    canTap = true;
                  }, 3000);
                });
              }, 2000);
            });
          }, 3000);
        });
      }, 4000);
    });
  }

  /* Follow stairs */
  else if (stage === 3) {
    diffuseTo("5.png", () => {
      // â³ hold moment at stairs
      setTimeout(() => {
        fade.style.opacity = "1";
        setTimeout(() => {
          window.location.href = "floor.html";
        }, 3000);
      }, 4000);
    });
  }
});
</script>

</body>
</html>